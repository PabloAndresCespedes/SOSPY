<!DOCTYPE html>

<html>
    <head>
        <meta name="format-detection" content="telephone=no">
        <meta name="msapplication-tap-highlight" content="no">
        <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width">
        <meta charset="UTF-8">

        <link rel="stylesheet" type="text/css" href="css/bootstrap.css">
        <link rel="stylesheet" type="text/css" href="css/bootstrap.min.css"> 
        <link rel="stylesheet" type="text/css" href="css/index.css">

        <link rel="stylesheet" type="text/css" href="css/font-awesome.min.css"/>

        <link rel="stylesheet" type="text/css" href="css/all.css">


        <link rel="stylesheet" type="text/css" href="css/vendor/font-awesome.min.css">
        <title>SOS PY</title>
        <script type="text/javascript" src="cordova.js"></script>
        <script src="js/jquery-2.1.3.min.js"></script>
        <script type="text/javascript" src="js/pacr.js"></script>
        <script>
            var db = null;
            //var llama = null;
            document.addEventListener("deviceready", onDeviceReady, false);
            /*FUNCION POR DEFECTO DE CORDOVA UTILIZADA COMO ONLOAD, PARA CONECTAR A LA BASE DE DATOS*/
            function onDeviceReady() {
                
                console.log("device is ready");
                db = window.sqlitePlugin.openDatabase({ name: "sospy.db", createFromLocation: 1 });
                ver();
            }

            function guardarContactos(){
            	db.transaction(listarGuardarContacto, error);
            }
            function ver(){
                db.transaction(vistaContactos,error);
            }
            function vistaContactos(tx){
            	
            	tx.executeSql("SELECT ID, NUMERO_EMERGENCIA, NOMBRE FROM CONTACTOS",[],function(tx, result){
            		var html = "";
            		var filasN = result.rows.length;
            		if(filasN > 0){
            			for (var i = 0; i < filasN; i++) {
                            var fila = result.rows.item(i);
                            html += "<tr><td id='nombre_1'>"+fila['NOMBRE']+"</td><td id="+fila['ID']+">"+fila['NUMERO_EMERGENCIA']+"</td><td><i class='fa fa-phone fa-lg verde' aria-hidden='true'></i></td><td><i class='fa fa-trash-o fa-lg rojo' aria-hidden='true'></i></td></tr>";
                            alert(html);
                        }
                       $(".tabla_contactos").html(html);
                    }
                    else {
                        alert("no hay datos");
                    }
            	});           	
            }

            function listarGuardarContacto(tx){
            	var id_actual = 0; 
            	var number;
            	var name;

                navigator.contacts.pickContact(function(contact){
                    var Obj = JSON.stringify(contact);
                    var myObj = JSON.parse(Obj);
                    name  = myObj.displayName;
                    number = myObj.phoneNumbers[0].value;

                },function(err){
                    alert('Error: ' + err);
                }); 

                tx.executeSql("select count(ID) as 'ID' from CONTACTOS", [], function (tx, result) {
                    var fila = result.rows.item(0);
                    
                        id_actual = parseInt(fila['ID']);

                        if (id_actual = 0) {
                            id_actual = 1;  
                            alert(id_actual);                        
                        }
                    });

                    tx.executeSql("insert into CONTACTOS(ID, NUMERO_EMERGENCIA, NOMBRE) values("+(id_actual+=1)+"," +"'"+ number +"'"+ ","+"'" +name +"'"+");", [], function (tx, result) {
                            alert("Sus datos han sido guardados");                     
                    });               
            }

            function onSuccess(contacts) {
                alert('Found ' + contacts.length + ' contacts.');
            };

            function onError(contactError) {
                alert('onError!');
            };

            function error(err) {
                alert("error =" + err.message);
            } 
        
            //FUNCION PARA CERRAR
            document.addEventListener('backbutton',function(e){
                console.log("history is "+ history.length);
                if(history.length==0){
                    navigator.app.exitApp();
                }
                else{
                    window.location.href="index2.html";
                }
                },false);

        </script>
        
    </head>
    <body>
       
        <div class="logo container-fluid">
            <img src="img/SOSPY.png" class="foto1 rounded mx-auto d-block" alt="Responsive image" align="left">            
        </div>    
        
        <br> <br> <br> <br> <br> <br>

        <div class="container-fluid">
            <img src="img/contacto.png" class="ic2 rounded mx-auto d-block" alt="Responsive image" align="center">
        </div>

        <div class="icono">
            <!--<div class="container-fluid" align="right">              
                <a class="icon btn btn-default">
                	<i class="fa fa-phone" aria-hidden="true"></i>
                </a> <br>
                <a class="icon btn btn-default">
                	<i class="fa fa-phone" aria-hidden="true"></i>
                </a> <br>
                <a class="icon btn btn-default">
                	<i class="fa fa-phone" aria-hidden="true"></i>
                </a>                  
            </div>

            <div class="container-fluid" align="right">
                <button  type="button">
                    <a class="icon btn btn-default"></a>
                    <i class="fa fa-phone" aria-hidden="true"></i>
                </button>
            </div>

            <div class="container-fluid" align="right">
                <button class="icon btn btn-default" type="button">
                    <a href="#"></a>
                    <i class="fa fa-phone" aria-hidden="true"></i>
                </button>
            </div>
        </div>-->
           
        
        
        <div class="navbar">
          <a href="index2.html"><i class="fa fa-fw fa-home"></i>Inicio</a> 
          <a href="index3.html"><i class="fa fa-fw fa-user"></i> Bomberos</a>  
          <a href="index4.html"><i class="fa fa-fw fa-user"></i> Policia</a>
          <a href="index5.html"><i class="fa fa-fw fa-envelope"></i> Contactos</a>
        </div>
              
       <!-- <div class="llamada">
            <select class="contact custom-select" id="1" onclick="listarContactos();" onchange="guardarContactos();">
                <option selected>Contacto de emergencia 1</option>
            </select>
            <br><br><br>
            <select class="contact custom-select" id="c2" onclick="listarContactos();" onchange="guardarContactos();">
                <option selected>Contacto de emergencia 2</option>
            </select>
            <br><br><br>
            <select class="contact custom-select" id="3" onclick="listarContactos();" onchange="guardarContactos();">
                <option selected>Contacto de emergencia 3</option> 
            </select>
        </div>-->
        <div class="button_container">
        	<button class="add_button" onclick="guardarContactos();">Agregar</button>
        </div>
        <div id="listaContactos">
        	<table id="tabla_contactos">
			  <tr>
			    <th>Nombre</th>
			    <th>NÃºmero</th>
			    <th>&nbsp</th>
			    <th>&nbsp</th>			    
			  </tr>
			  <tr>
			    <td id="nombre_1">Pepe</td>
			    <td id="numero_1">123</td>
			    <td><i class="fa fa-phone fa-lg verde" aria-hidden="true"></i></td>
			    <td><i class="fa fa-trash-o fa-lg rojo" aria-hidden="true"></i></td>
			  </tr>
			</table>
        </div>
        
        <script src="js/jquery-3.3.1.slim.min.js"></script>
        <script src="js/popper.min.js"></script>
        <script src="js/bootstrap.min.js"></script>
    </body>
</html>
